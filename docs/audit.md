# Документація модуля "Аудит"

Цей документ детально описує архітектуру та логіку роботи модуля "Аудит", включаючи взаємодію з користувачем, сервером, штучним інтелектом та базою даних.

## 1. Загальна концепція

Модуль "Аудит" — це інтерактивний інструмент для проведення бізнес-діагностики за допомогою AI-консультанта. Користувач (зазвичай власник або керівник) відповідає на питання AI в форматі діалогу (текстом або голосом). На основі відповідей система в реальному часі формує структурований звіт про стан бізнесу та, по завершенню, генерує план робіт для усунення знайдених слабких місць.

## 2. Сторінки та їх функціонал

### 2.1. Головна сторінка (`/audit`)

Це сторінка зі списком всіх аудитів, проведених у компанії.

-   **Список аудитів:** Відображає історію аудитів у таблиці з датою проведення та статусом ("В процесі" або "Завершено").
-   **Кнопка "Розпочати новий аудит":**
    -   Викликає серверний екшен `createAudit()`.
    -   Цей екшен створює новий документ у колекції `audits` в Firestore з початковими даними (статус `isCompleted: false`, перше повідомлення від бота тощо).
    -   Після успішного створення відбувається перенаправлення на сторінку нового аудиту (`/audit/[new_id]`).
    -   **Обмеження:** Кнопка неактивна, якщо аудит на поточний день вже було створено.
-   **Блок "Командний Аудит":** Інформаційний блок, що пояснює можливість залучення інших співробітників до аудиту через персональні посилання.

### 2.2. Сторінка проведення аудиту (`/audit/[id]`)

Це основний робочий екран, розділений на дві панелі.

-   **Ліва панель (Діалог з AI):**
    -   **Історія повідомлень:** Відображає листування з AI-консультантом.
    -   **Ввід відповіді:** Користувач може відповісти текстом через `Textarea` або записати голосове повідомлення за допомогою кнопки з мікрофоном.
    -   **Логіка відправки:**
        1.  Голосове повідомлення перетворюється на аудіофайл у форматі WebM (MIME-тип `audio/webm`).
        2.  Аудіофайл кодується у Base64 Data URI.
        3.  Викликається серверний екшен `continueAudit({ auditId, userAudioDataUri, userText })`.

-   **Права панель (Результати в реальному часі):**
    -   **"Поточна ситуація":** Відображає структурований звіт (`structuredSummary`), який оновлюється після кожної відповіді користувача.
    -   **Кнопка "Завершити аудит та згенерувати план":** Стає активною, коли AI вважає аудит завершеним (`isAiComplete: true`). Викликає екшен `finalizeAndSaveAudit()`.

-   **Перегляд завершеного аудиту:** Якщо `audit.isCompleted: true`, сторінка відображає фінальний звіт:
    -   **Пропозиція командного аудиту:** Картка із посиланнями для співробітників.
    -   **Результати аудиту:** Фінальна версія `structuredSummary`.
    -   **План робіт:** Згенерований AI `workPlan`.

## 3. Серверні екшени (`src/app/(app)/audit/actions.ts`)

Ці функції викликаються з клієнтських компонентів для взаємодії з сервером та базою даних.

-   `getAudits()`: Отримує всі аудити для поточної компанії.
-   `getAudit(id)`: Отримує конкретний аудит за його ID.
-   `createAudit()`: Створює новий документ в колекції `audits` з початковими налаштуваннями.
-   `updateAudit(id, updates)`: Оновлює документ аудиту.
-   `deleteAudit(id)`: Видаляє документ аудиту.

### `continueAudit(input)` - Ключовий екшен взаємодії

1.  **Отримує `auditId` та відповідь користувача** (або аудіо, або текст).
2.  **Транскрипція (якщо є аудіо):** Відправляє аудіо в `genkit` (модель `gemini-1.5-flash-latest`) для перетворення в текст.
3.  **Збереження відповіді:** Негайно оновлює документ в Firestore, додаючи відповідь користувача до `conversationHistory`. Це забезпечує збереження даних, навіть якщо AI-обробка завершиться з помилкою.
4.  **Виклик AI-логіки:** Викликає `getNextAuditStep(updatedHistory, currentSummary)`.
5.  **Обробка відповіді AI:**
    -   Отримує від AI наступне питання, оновлений звіт (`updatedSummary`) та прапорець завершення (`isComplete`).
    -   Зберігає відповідь AI та оновлений звіт в Firestore.
6.  **Обробка помилок:** Якщо крок з AI не вдався, екшен повертає `success: false`, але відповідь користувача вже збережена в базі. UI показує кнопку "Повторити".
7.  `retryAiProcessing(auditId)`: Дозволяє повторно запустити тільки крок AI-обробки для останнього повідомлення користувача.

### `finalizeAndSaveAudit(auditId)`

1.  Отримує фінальний `structuredSummary` з документу аудиту.
2.  Викликає AI-потік `generateWorkPlanFlow({ structuredSummary })` для генерації плану робіт.
3.  Створює новий документ у колекції **`auditResults`**, куди зберігає фінальну версію звіту та згенерований план.
4.  Оновлює початковий документ аудиту, встановлюючи `isCompleted: true` та додаючи `workPlan`.

## 4. Потоки штучного інтелекту (Genkit)

### 4.1. Транскрипція (`continueAudit`)

-   **Модель:** `googleai/gemini-1.5-flash-latest`
-   **Промпт:** `{media: {url: audioDataUri}}, {text: 'Транскрибуй це аудіо...'}`. Модель отримує аудіо та інструкцію для транскрипції.

### 4.2. Бесіда та збір даних (`conversational-audit-flow.ts`)

-   **Потік:** `getNextAuditStep()`
-   **Модель:** `googleai/gemini-1.5-flash-latest`
-   **Вхідні дані:**
    -   `conversationHistory`: Повна історія діалогу.
    -   `currentSummary`: Поточний JSON-звіт.
-   **Промпт:**
    -   Наказує AI діяти як бізнес-консультант з України.
    -   Містить чіткий **"План аудиту"** — послідовність тем та питань, яких AI має дотримуватися (Профіль компанії -> Команда -> Залученість власника -> Ключові співробітники -> Маркетинг і т.д.).
    -   Вимагає оновити JSON-звіт (`updatedSummary`) на основі останньої відповіді користувача.
    -   Вимагає надавати короткий коментар-інсайт перед тим, як поставити наступне питання.
    -   Вимагає встановити `isComplete: true`, коли всі пункти плану аудиту вичерпано.
-   **Вихідні дані (Zod схема):**
    -   `aiResponseText`: Наступне питання/репліка для користувача.
    -   `updatedSummary`: Оновлений JSON-об'єкт `AuditStructure`.
    -   `isComplete`: `boolean`.

### 4.3. Генерація плану робіт (`work-plan-flow.ts`)

-   **Потік:** `generateWorkPlan()`
-   **Модель:** `googleai/gemini-1.5-flash-latest`
-   **Вхідні дані:** `structuredSummary` (фінальний JSON-звіт).
-   **Промпт:**
    -   Наказує AI діяти як бізнес-консультант.
    -   Вимагає проаналізувати наданий JSON та виявити системні слабкості, особливо "пастку власника".
    -   Вимагає для кожної слабкості сформувати пару "Проблема" -> "Рішення".
    -   Вимагає категоризувати кожну проблему по відділах ("Маркетинг", "Продажі" і т.д.).
-   **Вихідні дані (Zod схема):** Масив об'єктів `WorkPlanItem`, кожен з яких містить `department`, `problem`, `solution`, `timelineMonths`.

## 5. Структура даних у Firestore

-   **Колекція `audits`:**
    -   Зберігає дані про аудити, що тривають, або історію.
    -   **Документ:**
        ```json
        {
          "id": "string",
          "companyId": "string",
          "createdAt": "ISO string",
          "conductedBy": { "userId": "string", "userName": "string" },
          "isCompleted": false,
          "isAiComplete": false,
          "conversationHistory": [ { "role": "user/model", "text": "..." } ],
          "structuredSummary": { /* JSON об'єкт типу AuditStructure */ },
          "workPlan": [ /* Масив об'єктів WorkPlanItem */ ]
        }
        ```

-   **Колекція `auditResults`:**
    -   Зберігає фінальні, незмінні результати завершених аудитів. Створюється для надійності та швидкого доступу до звітів.
    -   **Документ:**
        ```json
        {
          "id": "string",
          "companyId": "string",
          "auditId": "string", // Посилання на оригінальний аудит
          "createdAt": "ISO string",
          "conductedBy": { ... },
          "structuredSummary": { /* JSON об'єкт типу AuditStructure */ },
          "workPlan": [ /* Масив об'єктів WorkPlanItem */ ]
        }
        ```