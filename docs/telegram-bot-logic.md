# Специфікація логіки Telegram-бота для бекенду

Цей документ описує повну логіку, яку має реалізувати серверний бекенд для обробки вебхуків від Telegram та взаємодії з користувачами.

## 1. Потік Автентифікації

Цей потік активується, коли користувач починає взаємодію з ботом у приватному чаті для входу в додаток.

-   **Тригер:** Користувач переходить за посиланням `https://t.me/FinekoTasks_Bot?start=auth`, що надсилає боту команду `/start` з параметром `auth`.
-   **Процес на бекенді:**
    1.  Бекенд отримує від Telegram вебхук з об'єктом `message`, який містить дані про користувача (`message.from`).
    2.  Бекенд використовує `message.from.id` (Telegram User ID) для пошуку користувача в таблиці `users`.
    3.  Якщо користувач не знайдений, бекенд створює новий запис у таблиці `users`, зберігаючи `tg_user_id`, `first_name`, `last_name`, `telegram_username`.
    4.  Бекенд генерує **тимчасовий JWT-токен** (наприклад, з терміном дії 5 хвилин), в який записується внутрішній `id` користувача з вашої бази даних.
    5.  Бекенд надсилає повідомлення користувачу в Telegram з кнопкою, що містить посилання для повернення в додаток.

-   **Приклад відповіді (запит до Telegram API `sendMessage`):**
    ```json
    {
      "chat_id": "ID_ЧАТУ_З_КОРИСТУВАЧЕМ",
      "text": "Для завершення входу, будь ласка, натисніть кнопку нижче.",
      "reply_markup": {
        "inline_keyboard": [
          [
            {
              "text": "Завершити вхід",
              "url": "https://your-nextjs-app.com/auth/telegram/callback?token=ЗГЕНЕРОВАНИЙ_ТИМЧАСОВИЙ_ТОКЕН"
            }
          ]
        ]
      }
    }
    ```

## 2. Потік Прив'язки Групи

Цей потік активується, коли адміністратор додає бота в групу і викликає команду для прив'язки.

-   **Тригер:** Команда `/start` у груповому чаті, де бот є адміністратором.
-   **Процес на бекенді:**
    1.  Бекенд отримує вебхук з інформацією про групу (`message.chat`).
    2.  Генерує унікальний 6-значний код (наприклад, `XYZ123`).
    3.  Зберігає цей код у таблицю `group_link_codes` разом з `tg_group_id`, `group_title` та терміном дії (наприклад, 10 хвилин).
    4.  Надсилає повідомлення в груповий чат з цим кодом та інструкцією для користувача.

## 3. Обробка Команд (Природною мовою)

Це основний цикл роботи бота для керування задачами та результатами.

-   **Тригер:**
    -   Будь-яке повідомлення (текстове або аудіо) у приватному чаті з ботом.
    -   Повідомлення у груповому чаті, яке є відповіддю на повідомлення бота.
    -   Повідомлення у груповому чаті, в якому згадується ім'я бота (наприклад, `@FinekoTasks_Bot`).

-   **Процес на бекенді:**
    1.  **Отримання та підготовка вводу:**
        -   Якщо повідомлення текстове — взяти текст.
        -   Якщо повідомлення є **аудіофайлом**, бекенд має відправити його в сервіс транскрибації (наприклад, Google Speech-to-Text API) та отримати текстове представлення.

    2.  **Збір контексту:** Перед зверненням до AI, бекенд має зібрати з власної бази даних актуальну інформацію, що стосується компанії користувача:
        -   Список всіх співробітників (`employees`).
        -   Список всіх шаблонів (`templates`).
        -   Інформацію про поточного користувача (`currentUser`).

    3.  **Розпізнавання команди через AI:**
        -   Бекенд робить API-запит до мовної моделі (наприклад, Gemini), надсилаючи їй промпт, що містить текст користувача та зібраний контекст.
        -   **Мета промпту:** Перетворити неструктурований запит користувача на структурований JSON-об'єкт.
        -   **Приклад промпту для AI:**
            ```
            You are a command processing system for a task manager. Your task is to analyze the user's natural language command and convert it into a structured JSON format.

            Here is the context data you must use:
            - Current User: {{{json currentUser}}}
            - Available Employees: {{{json employees}}}
            - Available Templates: {{{json templates}}}
            - Allowed commands: ["create_task", "view_tasks", "edit_task_title", ...]

            User's command: "{{{userCommandText}}}"

            Based on the command and the provided context, identify the user's intent and parameters.
            - If the user wants to assign a task, find the correct employee ID from the 'Available Employees' list.
            - If the user's intent is unclear, set the command to 'clarify'.
            - If the command is not in the allowed list, set it to 'unknown'.

            Return a single JSON object with the following structure:
            {
              "command": "recognized_command_from_allowed_list",
              "text": "raw_text_for_the_task_or_result",
              "assigneeId": "employee_id_if_mentioned"
            }
            ```

    4.  **Виконання команди:**
        -   Бекенд отримує JSON-відповідь від AI.
        -   За допомогою конструкції `switch` або аналогічної, бекенд виконує дію, що відповідає полю `command`.
        -   Наприклад, якщо `command` дорівнює `create_task`, бекенд створює новий запис у таблиці `tasks`, використовуючи `text` як назву та `assigneeId` як ID відповідального.

    5.  **Відповідь користувачу:**
        -   Після успішного виконання дії, бекенд формує текстову відповідь (наприклад, "✅ Задача 'Підготувати звіт' створена для Марії Сидоренко.").
        -   Ця відповідь надсилається назад у той самий чат (приватний або груповий), звідки надійшов запит, за допомогою методу Telegram API `sendMessage`.
