# Повний потік автентифікації користувача

Цей документ крок за кроком описує весь процес входу користувача в систему, вказуючи на залучені сторінки фронтенду та ендпоінти бекенду.

**Учасники процесу:**
- **Frontend:** Веб-додаток на Next.js, з яким взаємодіє користувач.
- **Backend:** Ваш зовнішній сервер (наприклад, PHP), який обробляє логіку.
- **Telegram:** Месенджер, що виступає як провайдер автентифікації.

---

### Крок 1: Ініціація входу користувачем

-   **Актор:** Користувач.
-   **Сторінка на Frontend:** `/login`
-   **Дія:** Користувач натискає кнопку "Увійти через Telegram".
-   **Результат:** Браузер перенаправляє користувача за посиланням `https://t.me/FinekoTasks_Bot?start=auth`. Це відкриває чат з ботом у Telegram і надсилає йому команду `/start` з параметром `auth`.

---

### Крок 2: Обробка запиту від Telegram на Бекенді

-   **Актор:** Telegram -> Backend.
-   **Ендпоінт на Backend:** `POST /telegram/webhook` (URL, який ви вказуєте в налаштуваннях бота).
-   **Дія:**
    1.  Telegram надсилає на ваш вебхук об'єкт `message` з даними про користувача (`message.from`).
    2.  Бекенд перевіряє, що це команда `/start auth`.
    3.  **Бекенд викликає власну логіку, описану в ендпоінті `POST /auth/telegram/login`:**
        -   Знаходить користувача в базі даних за `telegramUserId`.
        -   Якщо користувач не знайдений, створює нового.
        -   Генерує **тимчасовий JWT токен** (термін дії ~5 хвилин), який містить внутрішній `userId`.
    4.  Бекенд, використовуючи свій токен бота, надсилає відповідь користувачу в Telegram.

-   **Приклад повідомлення, яке бекенд надсилає в Telegram:**
    ```json
    {
      "chat_id": "ID_ЧАТУ_КОРИСТУВАЧА",
      "text": "Для завершення входу, натисніть кнопку:",
      "reply_markup": {
        "inline_keyboard": [[
          {
            "text": "Завершити вхід",
            "url": "https://your-frontend-app.com/auth/telegram/callback?token=ЗГЕНЕРОВАНИЙ_ТИМЧАСОВИЙ_ТОКЕН"
          }
        ]]
      }
    }
    ```

---

### Крок 3: Повернення користувача на Frontend

-   **Актор:** Користувач.
-   **Сторінка на Frontend:** `/auth/telegram/callback`
-   **Дія:** Користувач натискає кнопку в повідомленні від бота і повертається у веб-додаток.
-   **Результат:** Сторінка завантажується, маючи в URL-параметрі `token` тимчасовий токен.

---

### Крок 4: Обмін тимчасового токена на дані про компанії

-   **Актор:** Frontend -> Backend.
-   **Сторінка на Frontend:** `/auth/telegram/callback`
-   **Ендпоінт на Backend:** `GET /auth/telegram/companies`
-   **Дія:**
    1.  Фронтенд-компонент `TelegramCallback` отримує `tempToken` з URL.
    2.  Він негайно надсилає GET-запит на бекенд, передаючи цей `tempToken` у заголовку `Authorization: Bearer <tempToken>`.
-   **Логіка на бекенді:**
    -   Бекенд валідує `tempToken` (перевіряє підпис та термін дії).
    -   Знаходить `userId` всередині токена.
    -   Шукає в базі даних, до яких компаній належить цей `userId`.
-   **Результат:** Бекенд повертає JSON-масив з компаніями користувача.

---

### Крок 5: Перенаправлення користувача в залежності від відповіді

-   **Актор:** Frontend.
-   **Сторінки на Frontend:** `/select-company` або `/create-company`
-   **Дія:** Фронтенд аналізує відповідь від бекенду:
    -   **Якщо масив компаній порожній:** Користувач перенаправляється на `/create-company?token=<tempToken>`, щоб створити першу компанію.
    -   **Якщо в масиві одна компанія:** Фронтенд автоматично переходить до Кроку 6.
    -   **Якщо в масиві більше однієї компанії:** Користувач перенаправляється на `/select-company?token=<tempToken>`, де йому буде показано список його компаній для вибору.

---

### Крок 6: Отримання постійного токена сесії

-   **Актор:** Frontend -> Backend.
-   **Сторінки на Frontend:** `/select-company`, `/create-company` або `/auth/telegram/callback` (у випадку однієї компанії).
-   **Ендпоінти на Backend:**
    -   `POST /auth/telegram/select-company`
    -   `POST /auth/telegram/create-company-and-login`
-   **Дія:**
    1.  Користувач або обирає компанію зі списку, або вводить назву для нової.
    2.  Фронтенд надсилає POST-запит на відповідний ендпоінт, передаючи в тілі запиту `companyId` або `companyName`, а в заголовках все той же `tempToken`.
-   **Логіка на бекенді:**
    -   Бекенд знову валідує `tempToken`.
    -   Перевіряє, чи має користувач доступ до вказаної `companyId` (або створює нову компанію).
    -   Якщо все вірно, генерує **постійний JWT токен** (з довшим терміном дії), який містить `userId` та `companyId`.
-   **Результат:** Бекенд повертає JSON з одним полем: `{ "token": "ВАШ_ПОСТІЙНИЙ_JWT_ТОКЕН" }`.

---

### Крок 7: Завершення входу

-   **Актор:** Frontend.
-   **Дія:**
    1.  Фронтенд отримує постійний токен.
    2.  Зберігає його в `httpOnly` cookie з назвою `auth_token`.
    3.  Перенаправляє користувача на головну сторінку додатку (`/`).

З цього моменту кожен наступний запит до захищених API-ендпоінтів буде автоматично включати цей `auth_token` в cookie, і бекенд зможе ідентифікувати користувача та його компанію.
