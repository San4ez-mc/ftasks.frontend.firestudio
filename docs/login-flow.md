# Повний потік автентифікації користувача

Цей документ крок за кроком описує весь процес входу користувача в систему, вказуючи на залучені сторінки фронтенду, проксі-ендпоінти на Next.js та ендпоінти на вашому основному бекенді.

**Учасники процесу:**
- **Frontend (Browser):** Веб-додаток на Next.js, з яким взаємодіє користувач.
- **Next.js Server (Proxy):** Серверна частина Next.js, що виступає як безпечний посередник.
- **Backend (PHP):** Ваш основний сервер, який керує логікою та даними.
- **Telegram:** Месенджер, що виступає як провайдер автентифікації.

---

### Крок 1: Ініціація входу користувачем

-   **Актор:** Користувач.
-   **Дія:** Користувач натискає кнопку "Увійти через Telegram".
-   **Приклади посилань:**
    -   `https://t.me/FinekoTasks_Bot?start=tasks` (вхід і перехід до завдань)
    -   `https://t.me/FinekoTasks_Bot?start=audit` (вхід і перехід до аудиту)
-   **Результат:** Відкривається чат з ботом, який отримує команду `/start` з параметром.

---

### Крок 2: Обробка запиту від Telegram на основному Бекенді

-   **Актор:** Telegram -> Backend (PHP).
-   **Ендпоінт на Backend:** `POST /telegram/webhook`
-   **Дія:**
    1.  Telegram надсилає на вебхук дані про користувача та параметр з команди `/start`.
    2.  Бекенд генерує **тимчасовий JWT токен** (термін дії ~5 хвилин).
    3.  Бекенд надсилає користувачу в Telegram повідомлення з кнопкою. URL кнопки містить цей тимчасовий токен та параметр `start` (наприклад, `tasks` або `audit`).

-   **Приклад відповіді (запит до Telegram API `sendMessage`):**
    ```json
    {
      "chat_id": "ID_ЧАТУ_КОРИСТУВАЧА",
      "text": "Для завершення входу, натисніть кнопку:",
      "reply_markup": {
        "inline_keyboard": [[
          {
            "text": "Завершити вхід",
            "url": "https://your-frontend-app.com/auth/telegram/callback?token=TEMP_TOKEN&start=audit"
          }
        ]]
      }
    }
    ```

---

### Крок 3: Повернення користувача на Frontend

-   **Актор:** Користувач.
-   **Сторінка на Frontend:** `/auth/telegram/callback`
-   **Дія:** Користувач натискає кнопку і повертається у веб-додаток.
-   **Результат:** Сторінка завантажується, маючи в URL-параметрах `token` (тимчасовий) та `start`.

---

### Крок 4: Запит списку компаній

-   **Актор:** Frontend -> Backend (PHP).
-   **Сторінка на Frontend:** `/auth/telegram/callback`
-   **Ендпоінт на Backend:** `GET /auth/telegram/companies`
-   **Дія:** Фронтенд надсилає GET-запит на бекенд, передаючи `tempToken` в заголовку `Authorization`.
-   **Результат:** Бекенд повертає масив компаній користувача.

---

### Крок 5: Перенаправлення користувача всередині Frontend

-   **Актор:** Frontend.
-   **Дія:** Фронтенд аналізує відповідь і перенаправляє користувача, "прокидаючи" далі `tempToken` та `start`.
    -   **Якщо компаній немає:** `/create-company?token=<tempToken>&start=<startParam>`
    -   **Якщо компаній більше однієї:** `/select-company?token=<tempToken>&start=<startParam>`
    -   **Якщо одна компанія:** Фронтенд одразу переходить до Кроку 6.

---

### Крок 6: Обмін тимчасового токена на постійний (Ключовий етап)

-   **Актори:** Frontend -> Next.js Server (Proxy) -> Backend (PHP).
-   **Сторінки на Frontend:** `/select-company`, `/create-company` або `/auth/telegram/callback`.
-   **Ендпоінти на Next.js Server:** `POST /api/auth/select-company` або `POST /api/auth/create-company`.
-   **Ендпоінти на Backend (PHP):** `POST /auth/telegram/select-company` або `POST /auth/telegram/create-company-and-login`.

-   **Процес:**
    1.  **Frontend -> Next.js Server:** Фронтенд викликає **свій власний API-маршрут** (наприклад, `POST /api/auth/select-company`), передаючи в тілі `tempToken` та `companyId`. **Фронтенд ніколи не бачить постійного токена.**
    2.  **Next.js Server -> Backend (PHP):** Next.js сервер (проксі) отримує цей запит і, в свою чергу, робить захищений сервер-сервер запит до вашого PHP-бекенду на відповідний ендпоінт.
    3.  **Backend (PHP) -> Next.js Server:** PHP-бекенд валідує `tempToken`, генерує **постійний JWT токен** і повертає його у JSON-відповіді `{ "token": "PERMANENT_JWT_TOKEN" }` **тільки для Next.js сервера**.

---

### Крок 7: Встановлення безпечного Cookie та фінальне перенаправлення

-   **Актори:** Next.js Server (Proxy) -> Frontend.
-   **Дія:**
    1.  **Next.js Server** отримує постійний токен від PHP-бекенду.
    2.  Він **не передає токен у тілі відповіді**, а встановлює його в `httpOnly` cookie.
        ```
        Set-Cookie: auth_token=PERMANENT_JWT_TOKEN; HttpOnly; Path=/; Max-Age=...
        ```
    3.  Next.js сервер надсилає відповідь браузеру (наприклад, `{ "success": true }`).
    4.  **Frontend** отримує успішну відповідь. Хоча він не бачить сам токен, браузер вже зберіг `httpOnly` cookie.
    5.  Фронтенд аналізує параметр `start` з URL і перенаправляє користувача:
        -   Якщо `start=audit`, то на `/audit`.
        -   В іншому випадку — на головну сторінку (`/`).

З цього моменту браузер буде автоматично надсилати `httpOnly` cookie `auth_token` з кожним наступним запитом до API, а ваш бекенд зможе його валідувати.