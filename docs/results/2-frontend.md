# Модуль "Результати": Опис Frontend

**Розташування файлу:** `src/app/(app)/results/page.tsx`

## 1. Основна структура компонента

Сторінка `ResultsPage` є головним клієнтським компонентом, що використовує хуки React (`useState`, `useEffect`, `useMemo`, `useTransition`) для управління станом та взаємодії з користувачем.

- **`containerRef`**: `useRef` для відстеження кліків за межами панелі деталей, щоб автоматично закривати її.
- **`startTransition`**: Використовується для асинхронних операцій (завантаження даних, оновлення), щоб інтерфейс не "зависав".
- **Стани:**
    - `results`: Масив усіх результатів компанії.
    - `employees`: Список співробітників для випадаючих списків.
    - `currentUser`: Профіль поточного користувача.
    - `selectedResult`: Об'єкт результату, який наразі відкрито в панелі деталей.
    - `viewMode`: `'table'` або `'cards'`.
    - `activeTab`: Поточний фільтр по відповідальності (`mine`, `delegated` і т.д.).
    - `statusFilter`: Масив вибраних статусів для фільтрації.

## 2. Ключові компоненти та елементи UI

### 2.1. Хедер (`<header>`)
- **Заголовок:** "Результати".
- **Перемикач режимів перегляду (`results-view-toggle`):** Дві кнопки-іконки (`List` та `LayoutGrid`) для перемикання між режимами `'table'` та `'cards'`. Стан зберігається в `localStorage`.
- **Вкладки фільтрації (`results-tabs`):** Компонент `Tabs` з `TabsList` та `TabsTrigger` для фільтрації за відповідальними: "Мої", "Делеговані", "Підлеглих", "Відкладені".
- **Фільтр по статусу:** Компонент `Popover` з `Checkbox` всередині для вибору одного або декількох статусів.

### 2.2. Основний контент (`<main>`)
Відображає один з двох компонентів залежно від `viewMode`:
- **`ResultsTable` (Режим таблиці):**
    - **Групування:** Якщо активна вкладка не "Мої", результати групуються за відповідальними. Ім'я та аватар кожного відповідального виводяться як заголовок групи.
    - **`ResultRow` (Рядок результату):**
        - Відображає основну інформацію: прапорець виконання, назву, дедлайн, відповідального, статус.
        - При наведенні з'являється блок з кнопками-іконками для швидких дій (редагувати, додати підрезультат, відкласти, створити задачу, видалити).
        - Клік по рядку відкриває панель деталей.
    - **`SubResultRows` (Рядки підрезультатів):**
        - Рекурсивний компонент, що рендерить вкладені підрезультати з візуальним відступом (`paddingLeft`).
        - Кожен рядок має прапорець, назву та кнопки швидких дій.
- **`ResultsCards` (Режим карток):**
    - Відображає результати у вигляді сітки з компонентів `Card`.
    - Кожна картка містить назву, дедлайн, відповідального та статус.
    - Клік по картці відкриває панель деталей.

### 2.3. Кнопка створення (`create-result-fab`)
- Плаваюча кнопка (`position: fixed`) в правому нижньому куті екрана.
- Іконка `Plus`.
- При натисканні викликає функцію `handleCreateNewResult`, яка створює новий порожній об'єкт результату та одразу відкриває його в панелі деталей для редагування.

### 2.4. Панель деталей (`ResultDetailsPanel`)
- **Розташування файлу:** `src/components/results/result-details-panel.tsx`.
- **Поведінка:** З'являється справа, займаючи половину екрана, коли `selectedResult` не є `null`.
- **Компоненти:**
    - **Назва:** Поле `Input`, яке дозволяє редагувати назву "на місці".
    - **Дедлайн, Статус, Відповідальний:** Інтерактивні елементи (`Popover` з `Calendar`, `Select`) для зміни відповідних полів.
    - **Опис та Очікуваний результат:** Поля `Textarea` для детального опису.
    - **Список доступів (`AccessListCombobox`):** Компонент для вибору співробітників, які матимуть доступ до перегляду цього результату.
    - **Підрезультати (`SubResultList`):** Інтерактивний список для додавання, редагування та видалення вкладених підрезультатів.
    - **Задачі та Шаблони:** Списки пов'язаних сутностей з кнопками для їх створення.
    - **Коментарі:** Блок для перегляду та додавання коментарів.

## 3. Логіка та потік даних
1.  **Ініціалізація:** При завантаженні сторінки `useEffect` викликає серверні екшени `getResults` та `getEmployees` для отримання початкових даних.
2.  **Фільтрація:** `useMemo` використовується для обчислення `filteredResults` на клієнті щоразу, коли змінюються `results`, `activeTab` або `statusFilter`.
3.  **Вибір результату:** Клік на рядок/картку встановлює `selectedResult`, що спричиняє рендер `ResultDetailsPanel`.
4.  **Редагування:** Зміни в `ResultDetailsPanel` оновлюють локальний стан `localResult`. При втраті фокусу (`onBlur`) або натисканні на кнопку збереження викликається `onUpdate`.
5.  **Оновлення:** Функція `handleResultUpdate` виконує оптимістичне оновлення UI (негайно показує зміни) та відправляє запит на бекенд через серверний екшен `updateResult`. У випадку помилки дані синхронізуються з сервера.
6.  **Створення:** Кнопка FAB викликає `handleCreateNewResult`, яка створює новий результат через `createResult`, додає його до локального стану та одразу відкриває для редагування.
7.  **Видалення:** Викликає `handleDeleteResult`, яка оптимістично видаляє результат з UI та відправляє запит на бекенд.