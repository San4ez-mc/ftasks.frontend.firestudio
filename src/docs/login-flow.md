# Процес Авторизації

Цей документ описує повний процес автентифікації користувачів, починаючи з фронтенду і закінчуючи отриманням доступу до API.

## Загальний Огляд

Процес починається на фронтенді. Неавторизований користувач перенаправляється в Telegram для ідентифікації, після чого повертається на фронтенд для вибору або створення компанії. Успішне завершення цього кроку надає користувачеві довгоживучий JWT для доступу до API.

## Покроковий Процес

1.  **Початок на Фронтенді та Перевірка Сесії**

    - Користувач заходить на сайт (наприклад, на головну сторінку).
    - Фронтенд-додаток перевіряє наявність дійсного JWT у локальному сховищі.
    - **Якщо токен є і він валідний:** користувач бачить основний інтерфейс (наприклад, сторінку задач).
    - **Якщо токена немає:** користувача перенаправляє на сторінку входу.

2.  **Перехід до Telegram для Ідентифікації**

    - На сторінці входу є кнопка "Увійти через Telegram".
    - Вона містить посилання на Telegram-бота, яке включає параметр `start` для зворотньої переадресації. Наприклад, `https://t.me/your_bot?start=tasks`.
    - Цей параметр (`tasks`) зберігається на фронтенді, щоб знати, куди повернути користувача після успішного входу.

3.  **Отримання Тимчасового Токена в Telegram**

    - Користувач натискає `start` у боті.
    - Бекенд генерує **короткоживучий тимчасовий токен**, пов'язаний з Telegram ID користувача.
    - Бот надсилає кнопку "Увійти", яка містить посилання на фронтенд з цим токеном: `https://<your-app-url>/auth/telegram/callback?token=<temporary_token>`.

4.  **Повернення на Фронтенд та Отримання Списку Компаній**

    - Користувач натискає кнопку і повертається на фронтенд.
    - Фронтенд-додаток отримує тимчасовий токен з URL і негайно робить з ним запит на бекенд (`/api/auth/telegram-companies`) для отримання списку компаній, доступних користувачеві.

5.  **Вибір або Створення Компанії (Ключовий Етап)**

    - **Сценарій 1: Якщо список компаній порожній.**
        - Фронтенд показує форму для створення нової компанії. Користувач вводить назву та інші дані і відправляє запит на `/api/auth/telegram-create-company`.
    - **Сценарій 2: Якщо у списку лише одна компанія.**
        - Фронтенд автоматично, без участі користувача, відправляє її ID на ендпоінт `/api/auth/telegram-select-company`.
    - **Сценарій 3: Якщо у списку кілька компаній.**
        - Фронтенд показує користувачеві список для вибору. Після вибору, ID компанії відправляється на `/api/auth/telegram-select-company`.

6.  **Отримання Постійного Токена**

    - У відповідь на успішний запит створення або вибору компанії бекенд генерує і повертає **довгоживучий JWT**.
    - Цей токен містить `userId`, `companyId` та термін дії (напр., 30 днів).

7.  **Завершення Авторизації та Переадресація**

    - Фронтенд отримує та зберігає постійний JWT у локальному сховищі.
    - Використовуючи збережений на кроці 2 параметр `start`, фронтенд перенаправляє користувача на відповідну сторінку (наприклад, `/tasks`).

## Використання Постійного JWT

Для всіх подальших запитів до захищених ендпоінтів API фронтенд повинен додавати цей JWT у заголовок `Authorization` як `Bearer` токен.
