# Технічне Завдання: Модуль "AI Аудит"

## 1. Загальна концепція

Модуль "AI Аудит" — це інтерактивний інструмент для проведення глибокого аналізу бізнесу за допомогою діалогу з AI-консультантом. Система ставить користувачеві (зазвичай власнику або керівнику) низку питань про ключові аспекти діяльності компанії, в реальному часі структурує отриману інформацію і за результатами генерує план робіт для усунення слабких місць.

## 2. Основні сторінки та UI

### 2.1. Головна сторінка модуля (`/audit`)
- **Призначення:** Відображення списку всіх проведених та незавершених аудитів.
- **Елементи:**
    - Заголовок: "Аудити компанії".
    - Кнопка **"Розпочати новий аудит"**: Створює новий запис аудиту в базі даних і перенаправляє користувача на сторінку проведення аудиту (`/audit/[id]`). Кнопка може бути неактивною, якщо аудит вже проводився сьогодні.
    - Інформаційний блок про "Командний аудит".
    - Таблиця з історією аудитів:
        - Колонки: "Дата та час", "Статус" ("В процесі" / "Завершено"), "Дії".
        - Кнопки дій: "Продовжити" (для незавершених) або "Переглянути" (для завершених), кнопка "Видалити".

### 2.2. Сторінка проведення аудиту (`/audit/[id]`)
- **Призначення:** Основний інтерфейс для взаємодії з AI-консультантом.
- **Режим "В процесі":**
    - **Ліва панель (Діалог):**
        - Відображення історії повідомлень між користувачем та AI.
        - Поле вводу для текстових відповідей з кнопкою "Відправити".
        - Кнопка для запису голосових повідомлень (Mic / Square).
        - Індикатор завантаження під час обробки відповіді AI.
        - Таймер тривалості аудиту.
    - **Права панель (Резюме):**
        - Заголовок "Поточна ситуація".
        - Динамічно оновлюваний блок, що відображає структуроване резюме (`structuredSummary`) у читабельному форматі.
        - Кнопка **"Завершити аудит та згенерувати план"**: Стає активною, коли AI ставить усі заплановані питання (`isAiComplete: true`).
- **Режим "Завершено":**
    - Сторінка ділиться на дві колонки для перегляду фінальних результатів.
    - **Блок "Командний аудит"**: Пропозиція провести аудит для ключових співробітників з можливістю скопіювати для них унікальні посилання.
    - **Ліва колонка "Поточна ситуація"**: Фінальне структуроване резюме.
    - **Права колонка "План робіт"**: Згенерований AI план робіт, згрупований по відділах, з описом проблем, рішень та орієнтовних термінів.

## 3. Технічна реалізація та логіка

### 3.1. Моделі даних (Firestore)

- **Колекція `audits`:**
    - `id`: string
    - `companyId`: string
    - `createdAt`: string (ISO)
    - `isCompleted`: boolean
    - `isAiComplete`: boolean
    - `conductedBy`: { userId: string, userName: string }
    - `conversationHistory`: Array<{ role: 'user' | 'model', text: string }>
    - `structuredSummary`: Object (JSON, відповідає `AuditStructureSchema`)
    - `workPlan`: Array<{ department: string, problem: string, solution: string, timelineMonths: number }>

### 3.2. Серверні дії (`actions.ts`)

- `createAudit()`: Створює новий документ в `audits` з початковим вітальним повідомленням від AI.
- `getAudit(id)`: Отримує дані конкретного аудиту.
- `continueAudit(input)`: Основна дія, що керує діалогом.
    1.  Приймає `auditId` та відповідь користувача (текст або аудіо).
    2.  Якщо аудіо - транскрибує його в текст.
    3.  Зберігає відповідь користувача в `conversationHistory`.
    4.  Викликає AI-flow `getNextAuditStep`, передаючи йому всю історію та поточне резюме.
    5.  Отримує від flow відповідь AI, оновлене резюме та прапор завершення.
    6.  Зберігає відповідь AI та оновлене резюме в Firestore.
    7.  Повертає результат на клієнт.
- `finalizeAndSaveAudit(id)`:
    1.  Викликає AI-flow `generateWorkPlan`, передаючи фінальне `structuredSummary`.
    2.  Зберігає отриманий `workPlan` у відповідний документ аудиту.
    3.  Встановлює прапор `isCompleted: true`.

### 3.3. AI Flows (Genkit)

- **`conversational-audit-flow.ts` (`getNextAuditStep`)**:
    - **Призначення:** Ведення діалогу та збір даних.
    - **Вхід:** `conversationHistory`, `currentSummary`.
    - **Логіка:**
        - Аналізує останню відповідь користувача.
        - Оновлює JSON-об'єкт `currentSummary` на основі нової інформації.
        - Формулює коротку, змістовну репліку-коментар на відповідь користувача.
        - Визначає наступне питання згідно з планом аудиту (див. промпт).
        - Повертає текст відповіді (коментар + питання), оновлене резюме та прапор `isComplete`.
- **`work-plan-flow.ts` (`generateWorkPlan`)**:
    - **Призначення:** Створення фінального плану робіт.
    - **Вхід:** `structuredSummary`.
    - **Логіка:**
        - Аналізує весь об'єкт резюме.
        - Виявляє системні проблеми та "вузькі місця".
        - Для кожної проблеми формулює пару "Проблема" (як є) та "Рішення" (як має бути).
        - Групує проблеми по відділах.
        - Повертає масив об'єктів плану робіт.
